---
# tasks file for roles/install-and-configure-external-docker-registry
- name: Get Host Facts
  setup:

- name: Set Registry hostname if not set already
  set_fact:
    registry_host_fqdn: "{{ ansible_fqdn }}"
  when:
    - not registry_host_fqdn is defined or (registry_host_fqdn is defined and registry_host_fqdn == '')
  
- name: Import tasks to secure registry
  import_tasks: secure-registry.yml 
  when: 
    - secure_registry | bool

- name: Import tasks to create self signed certificate 
  import_tasks: generate-registry-certificate.yml
  when: 
    - secure_registry | bool
    - not registry_certfile is defined or (registry_certfile is defined and  registry_certfile == '')

- name: Import tasks to create Authentication file for Registry
  import_tasks: generate-registry-authentication.yml 
  when:
    - enable_authz_on_registry is defined and enable_authz_on_registry | bool
    - registry_admin_username is defined and registry_admin_username | length > 0
    - registry_admin_password is defined and registry_admin_password | length > 0

- name: Import tasks to install RPM based registry
  import_tasks: deploy-rpm-registry.yml
  when: 
    - not use_containeried_registry is defined or not use_containeried_registry | bool

- name: Import tasks to install containerized registry
  import_tasks: deploy-containerized-registry.yml
  when: 
    - use_containeried_registry is defined
    - use_containeried_registry | bool

- name: Import tasks to import registry certificate into bastion
  import_tasks: fetch-registry-certs.yml 
  when: 
    - secure_registry | bool
    - not registry_certfile is defined or (registry_certfile is defined and  registry_certfile == '')
